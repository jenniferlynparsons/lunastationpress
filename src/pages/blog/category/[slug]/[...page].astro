---
import BaseHead from "@components/BaseHead.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import PageHeader from "@components/PageHeader.astro";
import FormattedDate from "@components/FormattedDate.astro";
import BlogSidebar from "@components/BlogSidebar.astro";
import Pagination from "@components/Pagination.astro";
import LinkButton from "@components/LinkButton.astro";
import { SITE_TITLE } from "@/consts";
import { getCollection } from "astro:content";

export async function getStaticPaths({ paginate }: any) {
  const posts = (await getCollection("blog")).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
  
  // Generate categories dynamically from blog posts
  const categoryMap = new Map();
  posts.forEach(post => {
    const category = post.data.category;
    if (category) {
      const slug = category.toLowerCase().replace(/\s+/g, '-');
      if (!categoryMap.has(slug)) {
        categoryMap.set(slug, {
          slug: slug,
          name: category,
          posts: []
        });
      }
      categoryMap.get(slug).posts.push(post);
    }
  });
  
  const categories = Array.from(categoryMap.values());
  
  // Generate paginated routes for each category
  return categories.flatMap(category => 
    paginate(category.posts, {
      params: { slug: category.slug },
      props: { categoryName: category.name },
      pageSize: 5,
    })
  );
}

const { page } = Astro.props;
const { slug } = Astro.params;
const { categoryName } = Astro.props;
const posts = page.data;

const currentPage = page.currentPage;
const pageTitle = currentPage === 1 
  ? `${categoryName} | ${SITE_TITLE}` 
  : `${categoryName} - Page ${currentPage} | ${SITE_TITLE}`;
const pageDescription = `${categoryName} posts from Luna Station Press`;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={pageTitle} description={pageDescription} />
  </head>
  <body class="bg-white">
    <Header />

    <main>
      <PageHeader title={`${categoryName} from the Station`} backgroundImage="/images/bg_071.jpg" />

      <section class="py-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">
          <div class="flex flex-col lg:flex-row gap-8">
            <!-- Main Content -->
            <main class="flex-1 lg:w-2/3">
              <div class="space-y-12">
                {
                  posts.map((post: any) => (
                    <article class="border-b border-gray-200 pb-8 last:border-b-0">
                      <div class="flex items-start gap-4">
                        <!-- Comment icon (matching screenshot) -->
                        <div class="flex-shrink-0 w-12 h-12 bg-gray-600 rounded flex items-center justify-center text-white mt-1">
                          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h11c.55 0 1-.45 1-1z"/>
                          </svg>
                          <span class="absolute -bottom-1 -right-1 bg-gray-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                        </div>
                        
                        <!-- Post content -->
                        <div class="flex-1">
                          <h2 class="text-2xl md:text-3xl font-light text-gray-700 mb-3">
                            <a href={`/blog/${post.slug}/`} class=" no-underline">
                              {post.data.title}
                            </a>
                          </h2>
                          
                          <div class="text-sm text-gray-500 mb-4">
                            By {post.data.author} / <FormattedDate date={post.data.pubDate} />
                          </div>
                          
                          {post.data.excerpt && (
                            <div class="text-gray-600 leading-relaxed mb-4">
                              <p>{post.data.excerpt}</p>
                              <p>[...]</p>
                            </div>
                          )}
                          
                          <LinkButton url={`/blog/${post.slug}/`} linkText="Continue reading" />
                        </div>
                      </div>
                    </article>
                  ))
                }
              </div>
              
              <!-- Pagination -->
              <Pagination page={page} baseUrl={`/blog/category/${slug}`} />
            </main>

            <!-- Sidebar -->
            <BlogSidebar />
          </div>
        </div>
      </section>
    </main>

    <Footer />
  </body>
</html>