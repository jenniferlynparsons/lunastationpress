---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import PageContainer from "@components/PageContainer.astro";
import FormattedDate from "@components/FormattedDate.astro";
import CoverImage from "@components/CoverImage.astro";
import BookHero from "@components/BookHero.astro";
import AuthorBio from "@components/AuthorBio.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "@/consts";

type Props = CollectionEntry<"books">["data"];

const { title, pubDate, gumroadLink, weightlessLink, kindleLink, koboLink, coverImage, heroImage, author, amazonLink, payhipLink, itchLink, goodreadsLink, isbn10, isbn13, pageCount, genre, category } = Astro.props;

// Get related books by the same author
const allBooks = await getCollection("books");
const relatedBooks = allBooks.filter((book) => book.data.author === author && book.data.title !== title).slice(0, 3); // Show up to 3 related books

// Get author information
let authorData: CollectionEntry<"authors"> | undefined = undefined;
if (author) {
  try {
    const allAuthors = await getCollection("authors");
    // First try to match by name, then by slug derived from author name
    authorData = allAuthors.find((authorEntry) => {
      const authorSlug = author.toLowerCase().replace(/\s+/g, "-");
      return authorEntry.data.name === author || authorEntry.slug === authorSlug;
    });
  } catch (error) {
    console.log("Authors collection not found or error fetching author data:", error);
  }
}
---

<PageContainer title={`${title} - ${SITE_TITLE}`} description={SITE_DESCRIPTION} headerType="standard" containerClass="">
  <!-- Hero Section -->
  {heroImage && author && <BookHero title={title} author={author} heroImage={heroImage} />}

  <!-- Main Content Section -->
  <div class="container w-full flex flex-col lg:flex-row flex-grow overflow-hidden mb-20 mt-20 max-w-6xl px-4 sm:px-6 lg:px-8 mx-auto py-12">
    <!-- Book Cover -->
    <div class="w-full lg:w-1/3 mb-8 lg:mb-0 flex justify-center lg:justify-start">
      {
        coverImage ? (
          <div class="max-w-xs lg:max-w-sm">
            <CoverImage imagePath={coverImage} altText={`Cover of ${title}`} />
          </div>
        ) : (
          <div class="max-w-xs lg:max-w-sm bg-gray-200 aspect-[2/3] rounded flex items-center justify-center">
            <span class="text-gray-500 text-sm">No cover available</span>
          </div>
        )
      }
    </div>

    <!-- Book Details -->
    <div class="w-full lg:w-2/3 lg:ml-12">
      <!-- Book Description -->
      <div class="prose prose-lg max-w-none mb-8 text-gray-700 leading-relaxed">
        <slot />
      </div>

      <!-- Book Metadata -->
      <div class="bg-gray-50 p-6 rounded-lg mb-8">
        <ul class="list-disc list-inside space-y-2 text-sm text-gray-600">
          <li><strong>Genre:</strong> {genre}</li>
          <li><strong>Print Length:</strong> {pageCount} pages</li>
          <li><strong>Publication Date:</strong> <FormattedDate date={pubDate} /></li>
          <li><strong>ISBN:</strong> {isbn13}</li>
        </ul>
      </div>

      <!-- Purchase Links -->
      <div class="py-6 mb-8">
        <div class="flex flex-wrap gap-4">
          {
            amazonLink && (
              <a href={amazonLink} class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
                Paperback
              </a>
            )
          }
          {
            (kindleLink || gumroadLink || payhipLink || koboLink || weightlessLink || itchLink) && (
              <div class="flex flex-wrap gap-2">
                {kindleLink && (
                  <a href={kindleLink} class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                    Kindle
                  </a>
                )}
                {gumroadLink && (
                  <a href={gumroadLink} class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                    Gumroad
                  </a>
                )}
                {payhipLink && (
                  <a href={payhipLink} class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                    Payhip
                  </a>
                )}
                {koboLink && (
                  <a href={koboLink} class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                    Kobo
                  </a>
                )}
                {weightlessLink && (
                  <a href={weightlessLink} class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                    Weightless
                  </a>
                )}
                {itchLink && (
                  <a href={itchLink} class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                    itch.io
                  </a>
                )}
              </div>
            )
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Author Bio Section -->
  {author && authorData && <AuthorBio author={author} bio={authorData.data.bio} website={authorData.data.website} photoUrl={authorData.data.photoUrl} socialLinks={authorData.data.socialLinks} />}

  <!-- Related Works Section -->
  {
    relatedBooks.length > 0 && (
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 mb-20">
        <h2 class="text-3xl font-light text-center mb-12 text-gray-800">Related works</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 justify-center">
          {relatedBooks.map((book) => (
            <div class="flex flex-col items-center text-center max-w-xs mx-auto">
              <a href={`/books/${book.slug}`} class="block group">
                <div class="flex justify-center mb-4">
                  {book.data.coverImage ? (
                    <CoverImage imagePath={book.data.coverImage} altText={book.data.title} className="h-72" />
                  ) : (
                    <div class="bg-gray-200 aspect-[2/3] rounded flex items-center justify-center">
                      <span class="text-gray-500 text-sm">No cover available</span>
                    </div>
                  )}
                </div>
                <h3 class="text-lg font-medium text-gray-800 group-hover:text-blue-600 transition-colors">{book.data.title}</h3>
                <p class="text-sm text-gray-600">{book.data.author}</p>
              </a>
            </div>
          ))}
        </div>
      </div>
    )
  }
</PageContainer>
